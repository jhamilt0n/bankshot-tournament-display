name: Create DigitalPool Tournament

on:
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      tournament_json:
        description: 'Tournament JSON data (base64 encoded)'
        required: true
        type: string
  
  # Allow trigger via repository dispatch (API call from Pi)
  repository_dispatch:
    types: [create-tournament]

jobs:
  create-tournament:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install Python dependencies
        run: |
          pip install selenium webdriver-manager
      
      - name: Decode tournament data
        id: decode
        run: |
          # Handle both workflow_dispatch and repository_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "${{ inputs.tournament_json }}" | base64 -d > tournament_data.json
          else
            echo '${{ toJson(github.event.client_payload.tournament_data) }}' > tournament_data.json
          fi
          
          # Display tournament info
          echo "Tournament data:"
          cat tournament_data.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(f\"Name: {d.get('tournament',{}).get('name','N/A')}\")"
      
      - name: Run Selenium automation
        run: |
          cd scripts
          python create_digitalpool_tournament.py ../tournament_data.json --headless --no-confirm
        env:
          DISPLAY: ':99'
      
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: |
            scripts/*.png
            *.png
          if-no-files-found: ignore
      
      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Tournament created successfully!"
          else
            echo "❌ Tournament creation failed. Check screenshots for details."
          fi
