<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bankshot Display</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body, html {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background: #000;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 24px;
            text-align: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 5px 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 3px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>üé± Bankshot Display</div>
        <div class="spinner"></div>
        <div style="font-size: 16px; margin-top: 20px;">Connecting to server...</div>
    </div>
    <div id="status">Initializing...</div>
    <iframe id="display" style="display:none;"></iframe>

    <script>
        const DEBUG = window.location.search.includes('debug=1');
        if (DEBUG) {
            document.getElementById('status').style.display = 'block';
        }

        let currentPage = null;
        let serverUrl = null;

        function updateStatus(msg) {
            if (DEBUG) {
                document.getElementById('status').textContent = 
                    new Date().toLocaleTimeString() + ' - ' + msg;
            }
            console.log(msg);
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('display').style.display = 'block';
        }

        // Auto-discover server - try multiple methods
        async function discoverServer() {
            updateStatus('Discovering server...');

            // Method 1: If loaded from the server, use current origin
            if (window.location.hostname !== 'localhost' && 
                window.location.hostname !== '127.0.0.1' &&
                window.location.hostname !== '') {
                const testUrl = window.location.origin;
                updateStatus('Testing current host: ' + testUrl);
                
                if (await testServer(testUrl)) {
                    serverUrl = testUrl;
                    updateStatus('Using current host');
                    return true;
                }
            }

            // Method 2: Try mDNS hostname
            const mdnsHost = 'http://bankshot-display.local';
            updateStatus('Trying mDNS: ' + mdnsHost);
            if (await testServer(mdnsHost)) {
                serverUrl = mdnsHost;
                updateStatus('Found via mDNS');
                localStorage.setItem('bankshot_server', serverUrl);
                return true;
            }

            // Method 3: Try saved server from last time
            const savedUrl = localStorage.getItem('bankshot_server');
            if (savedUrl) {
                updateStatus('Trying saved URL: ' + savedUrl);
                if (await testServer(savedUrl)) {
                    serverUrl = savedUrl;
                    updateStatus('Using saved URL');
                    return true;
                }
            }

            updateStatus('Server not found');
            return false;
        }

        async function testServer(url) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 2000);
                
                const response = await fetch(url + '/get_tournament_data.php', {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeout);
                return response.ok;
            } catch (e) {
                return false;
            }
        }

        function checkAndSwitch() {
            if (!serverUrl) {
                updateStatus('No server URL available');
                return;
            }

            fetch(serverUrl + '/get_tournament_data.php?nocache=' + Date.now())
                .then(response => response.json())
                .then(data => {
                    const shouldShowTournament = data.display_tournament || false;
                    const tournamentName = data.tournament_name || 'Unknown';
                    const status = data.status || 'Unknown';
                    
                    updateStatus(`${tournamentName} | ${status} | Display: ${shouldShowTournament}`);
                    
                    const targetPage = shouldShowTournament ? 
                        serverUrl + '/index.php' : 
                        serverUrl + '/ads_display.html';
                    
                    if (targetPage !== currentPage) {
                        console.log(`Switching to ${targetPage}`);
                        updateStatus(`Loading ${targetPage}`);
                        
                        const iframe = document.getElementById('display');
                        iframe.src = targetPage;
                        currentPage = targetPage;
                        hideLoading();
                    }
                })
                .catch(err => {
                    console.error('Error checking tournament:', err);
                    updateStatus('Connection lost - retrying discovery...');
                    // Re-discover server if connection lost
                    setTimeout(() => {
                        discoverServer().then(found => {
                            if (found) checkAndSwitch();
                        });
                    }, 5000);
                });
        }

        // Start discovery and monitoring
        discoverServer().then(found => {
            if (found) {
                updateStatus('Server found: ' + serverUrl);
                checkAndSwitch();
                setInterval(checkAndSwitch, 30000);
            } else {
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #ff6b6b;">‚ùå Server Not Found</div>' +
                    '<div style="font-size: 14px; margin-top: 20px;">Retrying...</div>';
                // Keep trying
                setInterval(() => {
                    discoverServer().then(found => {
                        if (found) {
                            checkAndSwitch();
                            setInterval(checkAndSwitch, 30000);
                        }
                    });
                }, 10000);
            }
        });

        // Keep screen awake (prevents TV sleep on some platforms)
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen')
                .then(lock => console.log('Screen wake lock acquired'))
                .catch(err => console.log('Wake lock failed:', err));
        }
    </script>
</body>
</html>
